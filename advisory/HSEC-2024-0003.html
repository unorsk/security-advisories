<!DOCTYPE HTML><html><html><head><meta charset="UTF-8"><base href=".."><link rel="alternate" type="application/atom+xml" href="https://haskell.github.io/security-advisories/atom.xml"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Haskell Security.Advisories.Core</title><style>.advisories, .content {
    margin: 1em;
}
a {
    text-decoration: none;
}
a:visited {
    text-decoration: none;
    color: darkblue;
}
pre {
    background: lightgrey;
}</style></head><body><div class="pure-u-1"><div class="pure-menu pure-menu-horizontal"><span class="pure-menu-heading pure-menu-link">Advisories list</span><ul class="pure-menu-list"><li class="pure-menu-item"><a href="by-dates.html" class="pure-menu-link">by date</a></li><li class="pure-menu-item"><a href="by-packages.html" class="pure-menu-link">by package</a></li></ul></div></div><div class="content"><div class="pure-u-1"><pre><code class="language-toml">[advisory]
id = &quot;HSEC-2024-0003&quot;
cwe = [150]
keywords = [&quot;windows&quot;]
aliases = [&quot;CVE-2024-3566&quot;, &quot;VU#123335&quot;]
related = [&quot;CVE-2024-1874&quot;, &quot;CVE-2024-24576&quot;, &quot;CVE-2024-22423&quot;]

[[references]]
type = &quot;ARTICLE&quot;
url = &quot;https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/&quot;

[[references]]
type = &quot;ADVISORY&quot;
url = &quot;https://kb.cert.org/vuls/id/123335&quot;

[[references]]
type = &quot;FIX&quot;
url = &quot;https://github.com/haskell/process/commit/3c419f9eeedac024c9dccce544e5a6fb587179a5&quot;


[[affected]]
package = &quot;process&quot;
os = [&quot;mingw32&quot;]
cvss = &quot;CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H&quot;

[[affected.versions]]
introduced = &quot;1.0.0.0&quot;
fixed = &quot;1.6.19.0&quot;
</code></pre>
<h1>process: command injection via argument list on Windows</h1>
<p>The <em>process</em> library on Windows is vulnerable to a command injection
vulnerability, via <code>cmd.exe</code>'s interpretation of arguments.  Programs that
invoke batch files (<code>.bat</code>, <code>.cmd</code>) and pass arguments whose values are
affected by program inputs may be affected.</p>
<p>This issue was discovered in many programming languages' Windows process
execution behaviour.  It was tracked by CERT/CC as <strong>VU#123335</strong> and a
coordinated disclosure was made on 2024-04-09 17:00 UTC.</p>
<p>A fix was released in <em>process-1.6.19.0</em>.</p>
<h2>Background</h2>
<p>Unlike POSIX systems, Windows does not have a mechanism for passing multiple
arguments.Command line parsing is up to individual programs.</p>
<p>The <em>process</em> library defines the <code>RawCommand</code> constructor for specifying an
executable and its arguments:</p>
<pre><code class="language-haskell">data CmdSpec
  = ShellCommand String
  | RawCommand FilePath [String]
</code></pre>
<p>On Windows, the <code>RawCommand</code> executable name and arguments are serialised into
a single <em>command line</em> string, with separate arguments quoted separately.
<em>process</em> then invokes the Windows <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa"><code>CreateProcess</code></a>
routine with this command line string is given as the <code>lpCommandLine</code>
argument.</p>
<h2>Issue</h2>
<p>When executing <code>.bat</code> or <code>.cmd</code> files, <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa"><code>CreateProcess</code></a>
implicitly spawns <code>cmd.exe</code>.  The <code>System.Process</code> command line construction
does not escape characters with special meaning to <code>cmd.exe</code>.  As a
consequence, a command injection vulnerability arises when the following
conditions are satisfied:</p>
<ul>
<li>Program running on Windows
</li>
<li>Program executes a <code>.bat</code> or <code>.cmd</code> file
</li>
<li>The argument values include or are influenced by program input
</li>
</ul>
<h2>Demonstration</h2>
<p>The following batch file, <code>test.bat</code>, merely prints the executable name the
first two arguments (as interpreted by <code>cmd.exe</code>):</p>
<pre><code>@ECHO OFF
ECHO 0: %0
ECHO 1: %1
ECHO 2: %2
PAUSE
</code></pre>
<p>The following Haskell program executes <code>test.bat</code> with basic string arguments.
The output is as expected:</p>
<pre><code>λ&gt; readProcess &quot;test.bat&quot; [&quot;a&quot;,&quot;b&quot;] [] &gt;&gt;= putStrLn
0: &quot;test.bat&quot;
1: &quot;a&quot;
2: &quot;b&quot;
</code></pre>
<p>However, we can use a close quote and the <code>&amp;</code> character to induce <code>cmd.exe</code> to
execute a program named in the argument:</p>
<pre><code>λ&gt; readProcess &quot;test.bat&quot; [&quot;\&quot;&amp;calc.exe&quot;] [] &gt;&gt;= putStrLn
0: &quot;test.bat&quot;
1: &quot;\&quot;
2:
</code></pre>
<p>In addition to producing the above output, <code>calc.exe</code> is executed.</p>
<h2>Mitigation</h2>
<p>The lack of a general mechanism on Windows for safely conveying command line
arguments to programs increases the risk of this kind of security issue.  The
fact that <code>cmd.exe</code> command line parsing is complex and poorly documented
exacerbates this issue, and also heightens the risk that the fix is
incomplete, or causes other issues.</p>
<p>If possible, avoid executing batch files where arguments include or are
influenced by untrusted program inputs.  If it must be done, reject arguments
that include special characters including <code>&amp;</code> and <code>&quot;</code>.</p>
<h2>Fix versions</h2>
<p><em>process</em> was modified to perform additional escaping and quoting
when executing <code>.bat</code> and <code>.cmd</code> files on Windows (ignoring
character case).  The behaviour is unchanged in all other cases.</p>
<p>The fix was released in <em><strong>process-1.6.19.0</strong></em>.  The following GHC
releases were the first in their series to include a fixed version
of the <em>process</em> library:</p>
<ul>
<li><strong>GHC 9.10.1-alpha3</strong> (released 2024-04-15)
</li>
<li>GHC 9.8.x (<strong>no release with fix yet</strong>)
</li>
<li><strong>GHC 9.6.5</strong> (released 2024-04-16)
</li>
</ul>
<p>Such a change in semantics should normally result in a major version
bump.  Because we expect very few (if any) users will be impacted by
the behavioural change, the GHC team made a pragmatic decision to
avoid the disruption that a major version bump would cause.</p>
<h2>Acknowledgements</h2>
<p>Security researcher <strong>RyotaK</strong> discovered and responsibly disclosed
this vulnerability, coordinating the response across the many
affected langauges and ecosystems.</p>
<p>Ben Gamari commited and released the fix, which was based on a
proposal by Fraser Tweedale.  Fraser also improved the
<code>System.Process</code> module documentation to better explain the Windows
semantics.</p>
</div></div></body></html></html>